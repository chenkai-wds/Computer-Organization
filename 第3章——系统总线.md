# 系统总线  
## 3.1 总线的基本概念  
### 什么是总线  
总线是连接各个部件的信息传输线，是**各个部件共享的传输介质**。  

### 总线上信息的传送  
+ 串行  
把要传输的信息一位一位的把它放到总线上面去， 接收方再一位一位的进行接收。  
+ 并行  
要传输的数据多位同时放在总线上进行传输，接收方也同时接收多位数据。  

### 总线结构的计算机举例  
![alt text](images\单总线结构框图.png)  
![alt text](images\面向CPU的双总线结构框图.png)  
![alt text](images\存储器为中心的双总线结构框图.png)  

## 3.2 总线的分类  
### 1.片内总线  
**芯片内部**的总线。如果说总线在一个芯片内部，完成了芯片内部的不同部件之间的连接，把它叫做片内总线。
### 2.系统总线  
**计算机各部件之间**的信息传输线  
包含：  
+ 数据总线  
    **双向**，与机器字长、存储字长有关  
+ 地址总线  
    **单向**，与存储地址、I/O地址有关  
+ 控制总线  
    **有出，有入**  
### 3.通信总线  
用于**计算机系统之间**或**计算机系统与其他系统**（如控制仪表、移动通信等）之间的通信  
传输方式：
+ 串行通信总线  
+ 并行通信总线

## 3.3 总线的性能及性能指标  
### 总线特性  
1.机械特性 &emsp; 尺寸、形状、管脚数及排列顺序  
2.电气特性 &emsp; 传输方向和有效的电平范围  
3.功能特性 &emsp; 每根传输线的功能（地址、数据、控制）  
4.时间特性 &emsp; 信号的时序关系  

### 总线的性能指标  
1.总线宽度 &emsp; 数据线的根数  
2.标准传输率 &emsp; 每秒传输的最大字节数（MBps）  
3.时钟同步/异步 &emsp; 同步、不同步  
4.总线复用 &emsp; 地址线与数据线复用  
5.信号线数 &emsp; 地址线、数据线和控制线的总和  
6.总线控制方式 &emsp; 突发、自动、仲裁、逻辑、计数  
7.其他指标 &emsp; 负载能力  

## 3.4 总线结构  
一、单总线结构  
![alt text](images\单总线结构框图.png)  

二、多总线结构  
1.双总线结构  
![alt text](images\双总线结构.png)  

2.三总线结构  
![alt text](images\三总线结构.png)  

3.三总线结构的又一形式  
![alt text](images\三总线结构又一形式.png)

4.四总线结构  
![alt text](images\四总线结构.png)  

三、总线结构举例  
1.传统微型机总线结构  
![alt text](images\传统微型机总线结构.png)  

2.VL-BUS局部总线结构  
![alt text](images\VL-BUS局部总线结构.png)  

3.PCI总线结构  
![alt text](images\PCI总线结构.png)  

4.多层PCI总线结构  
![alt text](images\多层PCI总线结构.png)  

## 3.5 总线控制  
### 一、总线判优控制  
1.基本概念  
根据是否能提出总线请求，可以把总线上的设备分成两类  
+ 主设备（模块）  
对总线有**控制权**，可以提出总线的占用申请。并且在占用总线之后，可以控制和另外一台设备之间进行的通信过程。  

+ 从设备（模块）  
**响应**从主设备发来的总线命令。它本身不能对总线进行控制，也不能提出总线的占用请求。  

+ 总线判优控制  
    + 集中式（特征：总线控制部件集中在一起）  
        + 链式查询  
        + 计数器定时查询  
        + 独立请求方式  
    + 分布式  

#### 链式查询  
![alt text](images\链式查询.png)  

数据线：用于信息交换过程当中数据的传输  

I/O接口都通过BR发出总线请求，总线控制部件接收到BR的请求后会通过BG逐个检查I/O接口直到碰到第一个提出总线占用请求的接口，那么总线的使用权就给它。此接口会通过BS设置总线忙。  

此方式优先级与BG信号线的查询顺序有关，BG的查询顺序就是各个I/O设备占用总线的优先权的先后顺序。如果某个设备优先级很低，排的比较靠后，那么很可能它提出的总线占用请求一直都不会得到应答。此方式缺点是对电路故障很敏感，如BG线在向下查的过程中，某个设备故障导致信号无法向下传，那么后面的设备就再也无法获得总线的使用权。  
优点是结构很简单，增删设备容易，优先级算法也很简单。进行可靠性设计比较容易实现。  

#### 计数器定时查询  
![alt text](images\计数器定时查询.png)  

如果说某一主设备想占用总线和某一从设备进行数据传输，那么它通过BR线向总线控制部件提出总线占用请求。总线控制器在接收到了总线请求信号后，在能够响应、可以让出总线使用权的情况下，会启动计数器。计数器的值是随便的一个接口号，计数器的值通过设备地址线向外进行输出。设备地址线给出信号以后，比如说计数器值为0，则查询I/O接口0是否提出总线占用请求，如果没有，计数器自动加一对I/O接口1查询，以此类推直到找到提出了总线占用请求的设备，此设备通过BS线进行应答。  
优点是优先级确定非常灵活，计数器不同的值开始可以产生循环优先级  

#### 独立请求查询  
![alt text](images\独立请求查询.png)  
排队器给各个设备优先级排队  

### 二、总线通信控制  
1.目的 &emsp; 解决通信双方**协调配合**问题  
2.总线传输周期  
主设备和从设备之间完成一次完整的并且可靠的通讯需要的时间  
分为以下四个阶段：  
+ 申请分配阶段 &emsp; **主模块申请**，总线仲裁决定  
申请和分配主设备获得总线的使用权  
+ 寻址阶段 &emsp; 主模块向从模块**给出地址**和**命令**  
主设备要找到从设备要发出的地址和命令，通过地址找到从设备，通过命令控制从设备完成相应的操作   
+ 传数阶段  &emsp; 主模块和从模块**交换数据**  
从模块准备好数据可以进行数据发送和接收  
+ 结束阶段  &emsp; 主模块撤消**有关信息**  
主模块、从模块都撤消相关信息  

3.总线通信的四种方式  
+ 同步通信 &emsp; 由**统一时标**控制数据传送  
+ 异步通信 &emsp; 采用**应答方式**，没有公共时钟标准  
+ 半同步通信 &emsp; **同步、异步结合**  
+ 分离式通信 &emsp; 充分**挖掘**系统**总线每个瞬间**的潜力  

（1）同步式数据输入  
![alt text](images\同步式数据输入.png)  
（2）同步式数据输出  
![alt text](images\同步式数据输出.png)  
（3）异步通信  
![alt text](images\异步通信.png)  
（4）半同步通信（**同步、异步**结合）  
同步：  
**发送方**用系统**时钟前沿**发信号  
**接收方**用系统**时钟后沿**判断、识别  
异步：
允许不同速度的模块和谐工作  
增加一条**等待响应信号** $\overline{\text{WAIT}}$  

![alt text](images\输入数据为例的半同步通信时序.png)  
![alt text](images\半同步通信.png)  

上述三种通信的共同点  
一个总线传输周期（以输入数据为例）  
+ 主模块发地址、命令 &emsp; **占用总线**  
+ 从模块准备数据 &emsp; **不占用总线** &emsp; 总线空闲  
+ 从模块向主模块发数据 &emsp; **占用总线**  

（5）分离式通信  
**充分挖掘系统总线每个瞬间的潜力**  
一个总线传输周期  
+ 子周期1  
**主模块**申请**占用总线**，使用完后即**放弃总线**的使用权  
+ 子周期2  
**从模块**申请**占用总线**，将各种信息送至总线上（从模块变成主模块）  

分离式通信特点  
1.各模块有权申请占用总线  
2.采用同步方式通信，不等对方回答  
3.各模块准备数据时，不占用总线  
4.总线被占用时，无空闲  